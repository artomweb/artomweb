<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                "gtm.start": new Date().getTime(),
                event: "gtm.js",
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-WM77VVG");
    </script>
    <!-- End Google Tag Manager -->

    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="logo.jpg" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js" integrity="sha512-rKFvwjvE4liWPlFnvH4ZhRDfNZ9FOpdkD/BU5gAIA3VS3vOQrQ5BjKgbO3kxebKhHdHcNUHLqxQYSoxee9UwgA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/StephanWagner/svgMap@v2.1.1/dist/svgMap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/StephanWagner/svgMap@v2.1.1/dist/svgMap.min.css" rel="stylesheet" />

    <title>Archie Webster</title>
    <meta name="Description" content="Name: Archie Webster. This is my personal website" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90929098-3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag("js", new Date());

        gtag("config", "UA-90929098-3");
    </script>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-WM77VVG"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="title">Archie Webster</div>

    <div id="butns">
        <button class="button flickr-button" onclick="window.location.href = 'https://flickr.com/artomweb';">
        Flickr
      </button>
        <button class="button github-button" onclick="window.location.href = 'https://github.com/artomweb';">
        Github
      </button>
        <button class="button thing-button" onclick="window.location.href = 'https://www.thingiverse.com/artomweb2/designs';">
        Thingiverse
      </button>
        <button class="button projects-button" onclick="window.location.href = 'https://dev.to/artomweb';">
        Projects
      </button>
    </div>

    <div class="row">
        <div class="column">
            <div class="subHeadings">How much have I slept :)</div>

            <canvas id="sleep" class="imageContainer" width="300"></canvas>
        </div>

        <div class="column">
            <div class="subHeadings">How many steps have I done</div>

            <canvas id="steps" class="imageContainer" width="300"></canvas>
        </div>
    </div>

    <div class="row">
        <div class="column">
            <div class="subHeadings">How much Spotify?</div>

            <canvas id="spotify" class="imageContainer" width="300"></canvas>
        </div>

        <div class="column">
            <div class="subHeadings">What's my average heart rate</div>

            <canvas id="hr" class="imageContainer" width="300"></canvas>
        </div>
    </div>

    <p></p>

    <div id="svgMap"></div>

    <script type="text/javascript">
        let webAppUrl =
            "https://script.google.com/macros/s/AKfycbzOKBcpmXpn5iryKAqjzm9dfoaEdiMu2472VPDaEi9DAJF5lGpntNvPcA3sW3sOG8X8Jg/exec";

        async function getCountry() {
            let response = await fetch("http://ip-api.com/json");
            let country = await response.json();
            let body = {
                countryCode: country.countryCode,
            };
            console.log(body);
            let success = await fetch(webAppUrl, {
                method: "post",
                // mode: "no-cors",
                body: JSON.stringify(body),
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                },
            });
            // success = await success.json();
            return success;
        }

        function sendCountryCode() {
            getCountry()
                .then((resp) => {
                    console.log("COUNTRY", resp);
                })
                .catch((error) => console.log("ERROR", error));
        }

        let mapSheet =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vSRGkSebakEqYSJa9f6eBXJqNlmgy9JWhSFxbjV--duEF-WIPy9tirqIJHdyuuUmo-JTp1zFKB9M9SW/pub?output=csv";

        function mapInit() {
            Papa.parse(mapSheet, {
                download: true,
                header: true,
                complete: showMap,
            });
        }

        function showMap(dataIn) {
            sendCountryCode();
            let data = dataIn.data;
            let threshMin = data.reduce((prev, curr) =>
                prev.Visitors > curr.Visitors ? prev : curr
            ).Visitors;
            let threshMax = data.reduce((prev, curr) =>
                prev.Visitors < curr.Visitors ? prev : curr
            ).Visitors;
            console.log("Max", threshMax);
            console.log("Min", threshMin);
            data = data.reduce((obj, item) => {
                obj[item.Country] = {
                    Visitors: item.Visitors,
                };
                return obj;
            }, {});

            console.log(data);
            new svgMap({
                targetElementID: "svgMap",
                mouseWheelZoomEnabled: false,
                initialZoom: 1.06,
                minZoom: 1.06,
                maxZoom: 1.06,
                noDataText: "No Visitors :(",
                data: {
                    data: {
                        Visitors: {
                            name: "Number of Visitors:",
                            format: "{0}",
                            thousandSeparator: ",",
                            thresholdMax: threshMax,
                            thresholdMin: threshMin,
                        },
                    },
                    applyData: "Visitors",
                    values: data,
                },
            });
        }

        colorPallets = [
            ["#62bdc7", "#d8a0a1", "#657786", "#c37777"],
            ["#e07a5f", "#3d405b", "#81b29a", "#f2cc8f"],
            // ["#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51"],
            // ["#cae7b9", "#f3de8a", "#eb9486", "#7e7f9a"]
        ];

        function shuffle(a) {
            let j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        colors = colorPallets[Math.floor(Math.random() * colorPallets.length)];
        colors = shuffle(colors);
        let butns = document.getElementById("butns").children;
        let i, e;
        for (i = 0; i < butns.length; i++) {
            e = butns[i];
            e.style.backgroundColor = colors[i];
        }

        async function showGraphs() {
            init();
            stepsInit();
            spotifyInit();
            hrInit();
            mapInit();
        }

        let sleepSheetCsv =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7KSTLckW0c3wi-yuRfRD2SFpx1P3sSoVIK3IMFsoI26SLj-ycHqfdwwVW4zx1moJ4gXO1BTXOISjU/pub?gid=0&single=true&output=csv";

        function init() {
            Papa.parse(sleepSheetCsv, {
                download: true,
                header: true,
                complete: showSleepGraph,
            });
        }

        window.addEventListener("DOMContentLoaded", showGraphs);

        function secondsToMins(e) {
            let hours = (e / 3600).toString();
            let minutes = +(parseFloat("." + hours.split(".")[1]) * 60).toFixed() || "00";
            minutes = ("0" + minutes).slice(-2);
            return hours.split(".")[0] + ":" + minutes;
        }

        function showSleepGraph(inData) {
            allData = inData.data;

            allData.sort(function(a, b) {
                return new Date(b.Date).getTime() - new Date(a.Date).getTime();
            });

            if (allData.length > 7) {
                allData = allData.slice(0, 7);
            }

            let labels = allData.map(function(e) {
                return new Date(e.Date);
            });

            let data = allData.map(function(e) {
                return e.Duration;
            });

            let ctx = document.getElementById("sleep").getContext("2d");
            let myChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        tension: 0.3,
                        data: data,
                        backgroundColor: colors[0],
                    }, ],
                },

                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    legend: {
                        display: false,
                    },
                    scales: {
                        xAxes: [{
                            type: "time",
                            time: {
                                unit: "day",
                                round: "day",
                                displayFormats: {
                                    day: "MMM D",
                                },
                            },
                        }, ],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                callback: function(value, index, values) {
                                    return secondsToMins(value);
                                },
                            },
                        }, ],
                    },

                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                let label =
                                    data.datasets[tooltipItem.datasetIndex].label || "";

                                if (label) {
                                    label += ": ";
                                }

                                label += secondsToMins(tooltipItem.yLabel);
                                return label;
                            },
                        },
                    },
                },
            });
        }

        let stepsSheetCsv =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGUT0ubwboYgwiZo2owljuAdWeqH3uVeMJ4GkgHOLTZjMDQy5I4x1uTAGScssnkOLRcXkQY7WxOj-/pub?output=csv";

        function stepsInit() {
            Papa.parse(stepsSheetCsv, {
                download: true,
                header: true,
                complete: showStepsGraph,
            });
        }

        function showStepsGraph(inData) {
            let allData = inData.data;

            allData.sort(function(a, b) {
                return new Date(b.Date).getTime() - new Date(a.Date).getTime();
            });

            if (allData.length > 7) {
                allData = allData.slice(0, 7);
            }

            let labels = allData.map(function(e) {
                return new Date(e.Date);
            });

            let data = allData.map(function(e) {
                return e.Steps;
            });

            let ctx2 = document.getElementById("steps").getContext("2d");
            let myChart = new Chart(ctx2, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        tension: 0.3,

                        data: data,
                        backgroundColor: colors[1],
                    }, ],
                },

                options: {
                    maintainAspectRatio: true,
                    responsive: true,

                    legend: {
                        display: false,
                    },
                    scales: {
                        xAxes: [{
                            type: "time",
                            time: {
                                unit: "day",
                                round: "day",
                                displayFormats: {
                                    day: "MMM D",
                                },
                            },
                        }, ],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                            },
                        }, ],
                    },
                },
            });
        }

        // Spotify

        let spotifySheetCsv =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vSw3m_yyTByllweTNnIM13oR_P4RSXG2NpF3jfYKpmPtsS8a_s8qA7YIOdzaRgl6h5b2TSaY5ohuh6J/pub?output=csv";

        function spotifyInit() {
            Papa.parse(spotifySheetCsv, {
                download: true,
                header: true,
                complete: showSpotifyGraph,
            });
        }

        function showSpotifyGraph(inData) {
            let allData = inData.data;

            console.log(inData);

            allData.sort(function(a, b) {
                return new Date(b.Date).getTime() - new Date(a.Date).getTime();
            });

            if (allData.length > 7) {
                allData = allData.slice(0, 7);
            }

            let labels = allData.map(function(e) {
                return new Date(e.Date);
            });

            let data = allData.map(function(e) {
                // return e.Duration;
                return e.Value;
            });

            let ctx2 = document.getElementById("spotify").getContext("2d");
            let myChart = new Chart(ctx2, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        tension: 0.3,

                        data: data,
                        backgroundColor: colors[2],
                    }, ],
                },

                options: {
                    maintainAspectRatio: true,
                    responsive: true,

                    legend: {
                        display: false,
                    },
                    scales: {
                        xAxes: [{
                            type: "time",
                            time: {
                                unit: "day",
                                round: "day",
                                displayFormats: {
                                    day: "MMM D",
                                },
                            },
                        }, ],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                            },
                        }, ],
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                let label =
                                    data.datasets[tooltipItem.datasetIndex].label || "";

                                if (label) {
                                    label += ": ";
                                }

                                label += tooltipItem.yLabel + " songs";
                                return label;
                            },
                        },
                    },
                },
            });
        }

        let hrSheetCsv =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-bk-dIWZk-rrHjQWwhjKx-6XcYYIoXKfMmfe3SxY9fWstqk_iqVvvnKT1wwH43eiZCVuRm-SWjCc_/pub?output=csv";

        function hrInit() {
            Papa.parse(hrSheetCsv, {
                download: true,
                header: true,
                complete: showHrGraph,
            });
        }

        function showHrGraph(inData) {
            let allData = inData.data;

            allData.sort(function(a, b) {
                return new Date(b.Date).getTime() - new Date(a.Date).getTime();
            });

            if (allData.length > 7) {
                allData = allData.slice(0, 7);
            }

            let labels = allData.map(function(e) {
                return new Date(e.Date);
            });

            let data = allData.map(function(e) {
                return parseInt(e.Value);
            });

            let ctx2 = document.getElementById("hr").getContext("2d");
            let myChart = new Chart(ctx2, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        tension: 0.3,
                        data: data,
                        backgroundColor: colors[3],
                    }, ],
                },

                options: {
                    maintainAspectRatio: true,
                    responsive: true,

                    legend: {
                        display: false,
                    },
                    scales: {
                        xAxes: [{
                            type: "time",
                            time: {
                                unit: "day",
                                round: "day",
                                displayFormats: {
                                    day: "MMM D",
                                },
                            },
                        }, ],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                            },
                        }, ],
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                let label =
                                    data.datasets[tooltipItem.datasetIndex].label || "";

                                if (label) {
                                    label += ": ";
                                }

                                label += tooltipItem.yLabel + "BPM";
                                return label;
                            },
                        },
                    },
                },
            });
        }
    </script>
</body>

</html>