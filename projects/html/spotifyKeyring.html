<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Generating Spotify keyrings with Python and Blender</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
    <link rel="stylesheet" href="/projects/css/pandoc.css" />
    <meta name="keywords" content="Foo,Bar" />
    <meta name="description" content="My description" />
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Generating Spotify keyrings with Python and Blender</h1>
      <p class="date">28/04/21</p>
    </header>
    <p><img src="/projects/images/keyring/keyring.jpg" /></p>
    <p>
      The easiest way to understand Blender’s Python commands is to open up the
      GUI into the Scripting workspace. Here, any modification made to Blender’s
      UI is displayed in the console.
    </p>
    <p>
      For example when deleting the default cube, this is the output to the
      console:
    </p>
    <p><img src="/projects/images/keyring/keyring3.png" /></p>
    <h3 id="clearing-the-workspace">Clearing the workspace</h3>
    <p>
      The first thing you will want to do is delete everything in the default
      workspace. This makes sure that we are starting from a clean slate with no
      pesky default cube. Notice that we have to import Blender’s python module
      to be able to interact with Blender.
    </p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> bpy</a>
<a class="sourceLine" id="cb1-2" title="2">bpy.ops.<span class="bu">object</span>.select_all(action<span class="op">=</span><span class="st">&#39;SELECT&#39;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">bpy.ops.<span class="bu">object</span>.delete()</a>
<a class="sourceLine" id="cb1-4" title="4">bpy.ops.<span class="bu">object</span>.select_all(action<span class="op">=</span><span class="st">&#39;DESELECT&#39;</span>)</a></code></pre>
    </div>
    <h3 id="creating-the-base">Creating the base</h3>
    <p>
      Speaking of cubes, the first thing to do is add a cube for the base. As
      explained before, to find these commands I will add a cube and scale it to
      a size that looks good, then copy the log from the console.
    </p>
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1">bpy.ops.mesh.primitive_cube_add(enter_editmode<span class="op">=</span><span class="va">False</span>, align<span class="op">=</span><span class="st">&#39;WORLD&#39;</span>, location<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb2-2" title="2">bpy.context.<span class="bu">object</span>.scale <span class="op">=</span> (<span class="fl">0.005</span>, <span class="fl">0.03</span>, <span class="fl">0.001</span>)</a></code></pre>
    </div>
    <h3 id="cutting-the-keyring">Cutting the keyring</h3>
    <p>
      To make a hole for the keyring I will add a cylinder and then subtract it
      from the base with a boolean modifier. When creating the cube I copied the
      entire command from the terminal, however to simplify the code, most of
      these arguments are actually defaults.
    </p>
    <p>
      I can also combine translating and scaling the object into the add
      function. If in any doubt the console will output the actual arguments
      that have been parsed when you run the script.
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1">bpy.ops.mesh.primitive_cylinder_add(radius<span class="op">=</span><span class="fl">0.003</span>, depth<span class="op">=</span><span class="fl">0.005</span>, location<span class="op">=</span>(.<span class="dv">04</span>, <span class="fl">-0.024</span>, <span class="dv">0</span>))</a></code></pre>
    </div>
    <p>This line was actually run like this:</p>
    <p><img src="/projects/images/keyring/keyring4.jpg" /></p>
    <p>
      For the next step it will be useful to keep track of the cube and
      cylinder. You can’t assign objects to variables when you create them,
      however as they are the only objects in the scene, we can reference them
      like this:
    </p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1">cube <span class="op">=</span> bpy.data.objects[<span class="st">&#39;Cube&#39;</span>]</a>
<a class="sourceLine" id="cb4-2" title="2">cylinder <span class="op">=</span> bpy.data.objects[<span class="st">&#39;Cylinder&#39;</span>]</a></code></pre>
    </div>
    <p>Then we can create and apply the boolean modifier:</p>
    <div class="sourceCode" id="cb5">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1"><span class="bu">bool</span> <span class="op">=</span> cube.modifiers.new(<span class="bu">type</span><span class="op">=</span><span class="st">&quot;BOOLEAN&quot;</span>, name<span class="op">=</span><span class="st">&quot;bool&quot;</span>)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="bu">bool</span>.<span class="bu">object</span> <span class="op">=</span> cylinder</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="bu">bool</span>.operation <span class="op">=</span> <span class="st">&#39;DIFFERENCE&#39;</span></a>
<a class="sourceLine" id="cb5-4" title="4">bpy.context.view_layer.objects.active <span class="op">=</span> cube</a>
<a class="sourceLine" id="cb5-5" title="5">bpy.ops.<span class="bu">object</span>.modifier_apply(modifier<span class="op">=</span><span class="st">&quot;bool&quot;</span>)</a></code></pre>
    </div>
    <p>
      After the modifier has been applied, the cylinder can be deleted so that
      we don’t accidently export it with the STL:
    </p>
    <div class="sourceCode" id="cb6">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1">bpy.ops.<span class="bu">object</span>.select_all(action<span class="op">=</span><span class="st">&#39;DESELECT&#39;</span>)</a>
<a class="sourceLine" id="cb6-2" title="2">cylinder.select_set(<span class="va">True</span>)</a>
<a class="sourceLine" id="cb6-3" title="3">bpy.ops.<span class="bu">object</span>.delete()</a></code></pre>
    </div>
    <h3 id="getting-the-spotify-code">Getting the Spotify code</h3>
    <p>
      Spotify doesn’t have an API for it’s codes however their website,
      <a href="https://www.spotifycodes.com/#">Spotify Codes</a> makes a request
      to this url:
    </p>
    <blockquote>
      <p>
        https://scannables.scdn.co/uri/plain/{format}/{background-color}/{bar-color}/{resolution}/{URI}
      </p>
    </blockquote>
    <p>
      For this purpose we want an SVG so it can be used in Blender, therefore
      our base URL will look like this:
    </p>
    <p>https://scannables.scdn.co/uri/plain/svg/ffffff/black/640/</p>
    <p>Then all we need to do is append the song or playlist URI to the end.</p>
    <p>
      Blender can only open an SVG from a file so we must cache it into a file
      like this:
    </p>
    <div class="sourceCode" id="cb7">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> requests</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3">URI <span class="op">=</span> <span class="bu">input</span>(<span class="st">&quot;Enter a song URI&quot;</span>)</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5">r <span class="op">=</span> requests.get(<span class="st">&quot;https://scannables.scdn.co/uri/plain/svg/ffffff/black/640/&quot;</span> <span class="op">+</span> URI, stream<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;SpotifyCodeDownload.svg&quot;</span>, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(<span class="dv">1024</span>):</a>
<a class="sourceLine" id="cb7-9" title="9">        f.write(chunk)</a></code></pre>
    </div>
    <p>Then we can import it into Blender:</p>
    <div class="sourceCode" id="cb8">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1">bpy.ops.import_curve.svg(filepath<span class="op">=</span><span class="st">&quot;SpotifyCodeDownload.svg&quot;</span>, filter_glob<span class="op">=</span><span class="st">&quot;*.svg&quot;</span>)</a></code></pre>
    </div>
    <h3 id="processing-the-svg">Processing the SVG</h3>
    <p><img src="/projects/images/keyring/keyring5.png" /></p>
    <p>
      EEEK! The SVG is imported as hundreds of individual curves and there is no
      way around this.
    </p>
    <p>
      First of all, the curve named ‘curve’ is a rectangle surrounding the code
      so we can delete that. Don’t forget to deselect everything before you
      start selecting.
    </p>
    <div class="sourceCode" id="cb9">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1">bpy.ops.<span class="bu">object</span>.select_all(action<span class="op">=</span><span class="st">&#39;DESELECT&#39;</span>)</a>
<a class="sourceLine" id="cb9-2" title="2">bpy.data.objects[<span class="st">&#39;Curve&#39;</span>].select_set(<span class="va">True</span>)</a>
<a class="sourceLine" id="cb9-3" title="3">bpy.ops.<span class="bu">object</span>.delete()</a></code></pre>
    </div>
    <p>
      Next we can combine the rest of the curves into one mesh, this can be done
      by selecting all the curves in the collection named after the SVG file.
    </p>
    <p>
      In order to do most operations in Blender you need to have an active
      object, so after selecting the collection we will make Curve.001 the
      active object.
    </p>
    <div class="sourceCode" id="cb10">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1"><span class="cf">for</span> obj <span class="kw">in</span> bpy.data.collections[<span class="st">&#39;SpotifyCodeDownload.svg&#39;</span>].all_objects:</a>
<a class="sourceLine" id="cb10-2" title="2">        obj.select_set(<span class="va">True</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"></a>
<a class="sourceLine" id="cb10-5" title="5">bpy.context.view_layer.objects.active <span class="op">=</span> bpy.data.objects[<span class="st">&quot;Curve.001&quot;</span>]</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">bpy.ops.<span class="bu">object</span>.join()</a>
<a class="sourceLine" id="cb10-8" title="8"></a>
<a class="sourceLine" id="cb10-9" title="9">bpy.ops.<span class="bu">object</span>.convert(target<span class="op">=</span><span class="st">&#39;MESH&#39;</span>)</a>
<a class="sourceLine" id="cb10-10" title="10"></a>
<a class="sourceLine" id="cb10-11" title="11">bpy.ops.<span class="bu">object</span>.origin_set(<span class="bu">type</span><span class="op">=</span><span class="st">&#39;ORIGIN_GEOMETRY&#39;</span>, center<span class="op">=</span><span class="st">&#39;MEDIAN&#39;</span>)</a></code></pre>
    </div>
    <p>The scene currently looks like this:</p>
    <p><img src="/projects/images/keyring/keyring6.jpg" /></p>
    <p>
      So the last thing we need to do is move the SVG in the viewport and copy
      the output. The first two lines of this extract show an absolute rotation
      on the z axis.
    </p>
    <div class="sourceCode" id="cb11">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1">curve <span class="op">=</span> bpy.data.objects[<span class="st">&quot;Curve.001&quot;</span>]</a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3">curve.rotation_euler[<span class="dv">2</span>] <span class="op">=</span> <span class="fl">1.5708</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5">bpy.ops.transform.resize(value<span class="op">=</span>(<span class="fl">0.277968</span>, <span class="fl">0.277968</span>, <span class="fl">0.277968</span>))</a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8">bpy.ops.transform.translate(value<span class="op">=</span>(<span class="op">-</span><span class="fl">0.0734364</span>, <span class="fl">-0.0216113</span>, <span class="fl">0.0009043</span>))</a></code></pre>
    </div>
    <p>And then extrude it:</p>
    <div class="sourceCode" id="cb12">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb12-1" title="1">bpy.ops.<span class="bu">object</span>.mode_set(mode<span class="op">=</span><span class="st">&#39;EDIT&#39;</span>)</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3">bpy.ops.mesh.select_all(action<span class="op">=</span><span class="st">&#39;SELECT&#39;</span>)</a>
<a class="sourceLine" id="cb12-4" title="4"></a>
<a class="sourceLine" id="cb12-5" title="5">bpy.ops.mesh.extrude_region_move(MESH_OT_extrude_region<span class="op">=</span> TRANSFORM_OT_translate<span class="op">=</span>{<span class="st">&quot;value&quot;</span>:(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.000875622</span>), <span class="st">&quot;orient_type&quot;</span>:<span class="st">&#39;NORMAL&#39;</span>})</a>
<a class="sourceLine" id="cb12-6" title="6"></a>
<a class="sourceLine" id="cb12-7" title="7">bpy.ops.<span class="bu">object</span>.mode_set(mode<span class="op">=</span><span class="st">&#39;OBJECT&#39;</span>)</a></code></pre>
    </div>
    <h3 id="exporting">Exporting</h3>
    <p>Finally we can export everything as an stl so it can be 3D printed:</p>
    <div class="sourceCode" id="cb13">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb13-1" title="1">bpy.ops.<span class="bu">object</span>.select_all(action<span class="op">=</span><span class="st">&#39;SELECT&#39;</span>)</a>
<a class="sourceLine" id="cb13-2" title="2">bpy.ops.export_mesh.stl(filepath<span class="op">=</span><span class="st">&quot;out.stl&quot;</span>, use_selection<span class="op">=</span><span class="va">True</span>, global_scale<span class="op">=</span><span class="dv">1000</span>)</a></code></pre>
    </div>
    <p>And that’s it, the program can be run with this command:</p>
    <pre class="shell"><code>blender -b --python BlenderStl.py</code></pre>
    <p><img src="/projects/images/keyring/keyring2.jpg" /></p>
    <h2 id="full-code">Full code</h2>
    <p>You can find all the code here:</p>
    <p>
      <a href="https://github.com/artomweb/Spotify-Code-to-Stl" class="uri"
        >https://github.com/artomweb/Spotify-Code-to-Stl</a
      >
    </p>
  </body>
</html>
